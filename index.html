<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vibe Idea - Professional Edition</title>
  <!-- Cache buster: v5.0 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4f46e5;
      --primary-light: #818cf8;
      --primary-dark: #4338ca;
      --secondary: #f9fafb;
      --accent: #ec4899;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --transition: all 0.2s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    body {
      background: var(--gray-50);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: var(--gray-800);
    }

    #root {
      width: 100%;
      max-width: 900px;
      height: 90vh;
      background: white;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--gray-200);
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .header {
      background: white;
      border-bottom: 1px solid var(--gray-200);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .header-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 1.2rem;
      color: var(--primary);
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: var(--primary);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .header-stats {
      display: flex;
      gap: 20px;
      margin-left: auto;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.85rem;
      color: var(--gray-600);
    }

    .stat-value {
      font-weight: 600;
      font-size: 1rem;
      color: var(--gray-900);
    }

    .stat-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .messages-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: white;
    }

    .message {
      display: flex;
      gap: 12px;
      max-width: 85%;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message.system {
      align-self: flex-start;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-weight: 600;
      font-size: 0.8rem;
      color: white;
    }

    .avatar.user {
      background: var(--primary);
    }

    .avatar.system {
      background: var(--gray-700);
    }

    .message-bubble {
      padding: 14px 18px;
      border-radius: 18px;
      line-height: 1.5;
      box-shadow: var(--shadow-sm);
      position: relative;
      max-width: 100%;
    }

    .message.user .message-bubble {
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.system .message-bubble {
      background: var(--gray-100);
      color: var(--gray-800);
      border-bottom-left-radius: 4px;
    }

    .message-bubble p {
      margin: 0 0 8px 0;
    }

    .message-bubble p:last-child {
      margin-bottom: 0;
    }

    .idea-item {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      margin: 10px 0;
      font-size: 0.95rem;
      position: relative;
      transition: var(--transition);
    }

    .idea-item:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--primary-light);
    }

    .idea-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .idea-btn {
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .idea-btn:hover {
      background: var(--gray-200);
      transform: translateY(-1px);
    }

    .idea-btn.save-btn:hover {
      background: #fef2f2;
      color: var(--danger);
      border-color: #fecaca;
    }

    .idea-btn.like-btn:hover {
      background: #f0fdf4;
      color: var(--success);
      border-color: #bbf7d0;
    }

    .idea-btn.explore-btn:hover {
      background: #eff6ff;
      color: var(--primary);
      border-color: #bfdbfe;
    }

    .input-area {
      padding: 20px;
      background: white;
      border-top: 1px solid var(--gray-200);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .input-controls {
      display: flex;
      gap: 10px;
    }

    .input-area textarea {
      flex: 1;
      padding: 14px 18px;
      border: 1px solid var(--gray-300);
      border-radius: 12px;
      resize: none;
      height: 56px;
      font-size: 1rem;
      outline: none;
      transition: var(--transition);
      background: var(--gray-50);
    }

    .input-area textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      background: white;
    }

    .send-button {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      width: 56px;
      height: 56px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      font-size: 1.2rem;
    }

    .send-button:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .send-button:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: 18px;
      align-self: flex-start;
      font-size: 0.9rem;
      color: var(--gray-600);
    }

    .saved-ideas-panel {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-top: 12px;
      box-shadow: var(--shadow-md);
      display: none;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--gray-200);
    }

    .panel-title {
      font-weight: 600;
      color: var(--gray-900);
      font-size: 1rem;
    }

    .saved-idea {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      margin-bottom: 10px;
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .saved-idea:hover {
      box-shadow: var(--shadow-sm);
      background: white;
    }

    .idea-tag {
      display: inline-block;
      background: var(--primary-light);
      color: white;
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 0.7rem;
      margin-left: 8px;
      font-weight: 500;
    }

    .toggle-panel {
      background: var(--gray-100);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toggle-panel:hover {
      background: var(--gray-200);
      border-color: var(--gray-300);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      #root {
        height: 100vh;
        border-radius: 0;
        max-width: 100%;
      }

      .header {
        padding: 16px;
      }

      .header-stats {
        display: none;
      }

      .message {
        max-width: 90%;
      }

      .input-area {
        padding: 16px;
      }

      .input-controls {
        flex-direction: column;
      }

      .send-button {
        width: 100%;
        height: 48px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .message-bubble {
        padding: 12px 16px;
      }

      .idea-item {
        padding: 10px 14px;
      }
    }
  </style>
</head>
<body>
  <div id="root">
    <div class="app-container">
      <div class="header">
        <div class="header-content">
          <div class="logo">
            <div class="logo-icon">
              <i class="fas fa-lightbulb"></i>
            </div>
            <span>Vibe Idea</span>
          </div>
          <div class="tagline">AI创意伙伴</div>
        </div>
        <div class="header-stats">
          <div class="stat-item">
            <div class="stat-value" id="idea-count">0</div>
            <div class="stat-label">想法</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="saved-count">0</div>
            <div class="stat-label">收藏</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="domain-count">0</div>
            <div class="stat-label">领域</div>
          </div>
        </div>
      </div>
      
      <div id="messages-container" class="messages-container">
        <div class="message system">
          <div class="avatar system">
            <i class="fas fa-robot"></i>
          </div>
          <div class="message-bubble">
            <p>你好！我是你的AI创意伙伴，今天想探索什么有趣的想法？</p>
          </div>
        </div>
      </div>
      
      <div class="input-area">
        <div class="input-controls">
          <textarea id="user-input" placeholder="分享你的兴趣或问题..."></textarea>
          <button id="send-button" class="send-button">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
        <button id="show-saved-btn" class="toggle-panel">
          <i class="fas fa-bookmark"></i> 查看收藏的想法
        </button>
        <div id="saved-ideas-panel" class="saved-ideas-panel">
          <div class="panel-header">
            <div class="panel-title">收藏的想法</div>
            <button id="close-panel-btn" class="toggle-panel">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div id="saved-ideas-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Professional Idea Engine with Linear-style UI
    class ProfessionalIdeaEngine {
      constructor() {
        // Conversation history with enhanced metadata
        this.conversationHistory = [];
        
        // User preferences and learning
        this.userPreferences = {
          preferredDomains: {},
          favoriteTypes: {},
          engagementPatterns: {}
        };
        
        // Saved/liked ideas
        this.savedIdeas = [];
        
        // Statistics
        this.stats = {
          totalIdeas: 0,
          savedIdeas: 0,
          exploredDomains: new Set(),
          conversationTurns: 0
        };
        
        this.knowledgeDomains = [
          'technology', 'sustainability', 'education', 'health', 
          'creativity', 'business', 'social_impact', 'art'
        ];
        
        this.ideaTemplates = {
          technology: [
            'AI-powered solution to optimize {domain}',
            'Blockchain-based platform for {domain}',
            'IoT system to monitor and improve {domain}',
            'Mobile app to help users with {domain}',
            'AR/VR experience for {domain} education',
            'Machine learning model to predict {domain} trends',
            'Cybersecurity framework for {domain} systems',
            'Decentralized application for {domain}',
            'Voice interface for {domain} access',
            'Edge computing solution for {domain}'
          ],
          sustainability: [
            'Circular economy approach to {domain}',
            'Zero-waste solution for {domain}',
            'Renewable energy application in {domain}',
            'Community-driven {domain} initiative',
            'Upcycling project focused on {domain}',
            'Carbon footprint tracker for {domain} activities',
            'Water conservation method in {domain} processes',
            'Biodiversity monitoring system for {domain}',
            'Sustainable supply chain for {domain}',
            'Green transportation solution for {domain}'
          ],
          education: [
            'Interactive learning platform for {domain}',
            'Gamified approach to teaching {domain}',
            'Peer-to-peer knowledge sharing in {domain}',
            'Virtual reality classroom for {domain}',
            'AI tutor specializing in {domain}',
            'Open-source curriculum for {domain} skills',
            'Cross-cultural exchange program for {domain} learners',
            'Project-based learning for {domain}',
            'Skill assessment platform for {domain}',
            'Educational content creator tool for {domain}'
          ],
          health: [
            'Preventive care approach to {domain}',
            'Mental wellness program for {domain}',
            'Fitness tracking solution for {domain}',
            'Telemedicine platform for {domain}',
            'Nutrition-focused app for {domain}',
            'Community support group for {domain} challenges',
            'Wearable device to monitor {domain} metrics',
            'Personalized therapy approach for {domain}',
            'Health data analytics for {domain}',
            'Accessibility solution for {domain} patients'
          ],
          creativity: [
            'Collaborative workspace for {domain} creators',
            'AI-assisted {domain} generation tool',
            'Cross-media storytelling for {domain}',
            'Creative challenge platform for {domain}',
            'Digital archive for {domain} works',
            'Hybrid physical-digital {domain} studio',
            'NFT marketplace for {domain} artists',
            'Creative collaboration tool for {domain}',
            'Immersive {domain} experience',
            'Generative {domain} algorithm'
          ],
          business: [
            'Subscription model for {domain} services',
            'Marketplace connecting {domain} providers',
            'Freemium tool for {domain} professionals',
            'Consulting service specializing in {domain}',
            'White-label solution for {domain} businesses',
            'Micro-investment platform for {domain} startups',
            'Remote collaboration suite for {domain} teams',
            'Business intelligence for {domain} sector',
            'Customer success platform for {domain}',
            'Revenue optimization for {domain} companies'
          ],
          social_impact: [
            'Non-profit organization addressing {domain}',
            'Crowdfunding platform for {domain} projects',
            'Volunteer network focused on {domain}',
            'Awareness campaign for {domain} issues',
            'Policy advocacy around {domain}',
            'Global movement for {domain} rights',
            'Local community hub for {domain} initiatives',
            'Impact measurement tool for {domain}',
            'Social entrepreneurship incubator for {domain}',
            'Grassroots organizing platform for {domain}'
          ],
          art: [
            'Interactive {domain} installation',
            'Digital gallery for {domain} artists',
            'Collaborative {domain} project platform',
            '{domain} workshop series',
            'Augmented reality {domain} experience',
            'Cross-disciplinary {domain} fusion project',
            'Public {domain} art initiative',
            'Artist residency program for {domain}',
            'Art market platform for {domain}',
            'Cultural preservation project for {domain}'
          ]
        };
        
        this.followupTemplates = {
          exploration: [
            "你希望这个想法解决什么具体问题？",
            "你认为这个想法面临的最大挑战是什么？",
            "你觉得谁会从这个想法中受益最多？",
            "你想象中最理想的实现方式是什么样的？"
          ],
          refinement: [
            "你觉得这个想法的哪个方面最吸引你？",
            "有没有什么因素可能会阻碍这个想法的实现？",
            "你希望这个想法对社会产生什么样的影响？",
            "你愿意为此投入多少时间和精力？"
          ],
          inspiration: [
            "你最近在{domain}领域遇到过什么有趣的挑战吗？",
            "你认为{domain}领域目前最需要什么样的创新？",
            "你理想中的{domain}解决方案是什么样的？",
            "有没有什么{domain}相关的经历启发了你？"
          ],
          deep_dive: [
            "你能详细描述一下你希望实现的具体效果吗？",
            "你考虑过这个想法的长期影响吗？",
            "有没有其他领域可以借鉴类似的方法？",
            "你觉得这个想法如何适应未来的变化？"
          ]
        };
      }

      // Add message to conversation history with metadata
      addToHistory(message, isUser, metadata = {}) {
        this.conversationHistory.push({
          text: message,
          isUser: isUser,
          timestamp: Date.now(),
          ...metadata
        });
        
        // Keep only last 20 messages to avoid memory bloat
        if (this.conversationHistory.length > 20) {
          this.conversationHistory = this.conversationHistory.slice(-20);
        }
        
        this.stats.conversationTurns++;
      }

      // Learn from user interactions
      learnFromInteraction(userInput, response) {
        // Extract domains mentioned in user input
        const inputLower = userInput.toLowerCase();
        for (const domain of this.knowledgeDomains) {
          if (inputLower.includes(domain.replace('_', ' '))) {
            this.userPreferences.preferredDomains[domain] = (this.userPreferences.preferredDomains[domain] || 0) + 1;
          }
        }
        
        // Track engagement patterns
        this.userPreferences.engagementPatterns[this.stats.conversationTurns % 5] = 
          (this.userPreferences.engagementPatterns[this.stats.conversationTurns % 5] || 0) + 1;
      }

      // Get user's preferred domain based on history
      getPreferredDomain() {
        let maxCount = 0;
        let preferredDomain = 'general';
        
        for (const [domain, count] of Object.entries(this.userPreferences.preferredDomains)) {
          if (count > maxCount) {
            maxCount = count;
            preferredDomain = domain;
          }
        }
        
        return preferredDomain;
      }

      analyzeInput(userInput) {
        console.log("Professional analyzing input:", userInput);
        const input = userInput.toLowerCase();
        let scores = {};
        
        // Score each domain based on keyword matches
        for (const domain of this.knowledgeDomains) {
          let score = 0;
          
          // General keywords that appear across domains
          if (input.includes('app') || input.includes('application')) score += 2;
          if (input.includes('platform') || input.includes('system')) score += 2;
          if (input.includes('solution') || input.includes('solve')) score += 2;
          if (input.includes('help') || input.includes('assist')) score += 1;
          if (input.includes('community') || input.includes('people')) score += 1;
          if (input.includes('learn') || input.includes('education')) score += 1;
          
          // Domain-specific keywords
          switch(domain) {
            case 'technology':
              if (input.includes('ai') || input.includes('artificial intelligence')) score += 3;
              if (input.includes('blockchain') || input.includes('crypto')) score += 3;
              if (input.includes('mobile') || input.includes('app')) score += 2;
              if (input.includes('iot') || input.includes('internet of things')) score += 3;
              if (input.includes('data') || input.includes('algorithm')) score += 2;
              break;
              
            case 'sustainability':
              if (input.includes('sustainable') || input.includes('eco')) score += 3;
              if (input.includes('environment') || input.includes('green')) score += 3;
              if (input.includes('waste') || input.includes('zero')) score += 2;
              if (input.includes('energy') || input.includes('renewable')) score += 2;
              if (input.includes('circular') || input.includes('reuse')) score += 2;
              break;
              
            case 'education':
              if (input.includes('learn') || input.includes('teach')) score += 3;
              if (input.includes('school') || input.includes('student')) score += 2;
              if (input.includes('course') || input.includes('training')) score += 2;
              if (input.includes('knowledge') || input.includes('skill')) score += 2;
              if (input.includes('classroom') || input.includes('study')) score += 2;
              break;
              
            case 'health':
              if (input.includes('health') || input.includes('wellness')) score += 3;
              if (input.includes('fitness') || input.includes('exercise')) score += 2;
              if (input.includes('mental') || input.includes('therapy')) score += 2;
              if (input.includes('nutrition') || input.includes('diet')) score += 2;
              if (input.includes('medical') || input.includes('patient')) score += 2;
              break;
              
            case 'creativity':
              if (input.includes('creative') || input.includes('artistic')) score += 3;
              if (input.includes('design') || input.includes('creative')) score += 2;
              if (input.includes('music') || input.includes('visual')) score += 2;
              if (input.includes('writing') || input.includes('story')) score += 2;
              if (input.includes('maker') || input.includes('craft')) score += 2;
              break;
              
            case 'business':
              if (input.includes('business') || input.includes('startup')) score += 3;
              if (input.includes('market') || input.includes('customer')) score += 2;
              if (input.includes('revenue') || input.includes('profit')) score += 2;
              if (input.includes('service') || input.includes('product')) score += 2;
              if (input.includes('entrepreneur') || input.includes('venture')) score += 2;
              break;
              
            case 'social_impact':
              if (input.includes('impact') || input.includes('change')) score += 3;
              if (input.includes('community') || input.includes('social')) score += 2;
              if (input.includes('nonprofit') || input.includes('charity')) score += 2;
              if (input.includes('advocacy') || input.includes('awareness')) score += 2;
              if (input.includes('equity') || input.includes('accessibility')) score += 2;
              break;
              
            case 'art':
              if (input.includes('art') || input.includes('artist')) score += 3;
              if (input.includes('gallery') || input.includes('exhibition')) score += 2;
              if (input.includes('creative') || input.includes('expression')) score += 2;
              if (input.includes('culture') || input.includes('heritage')) score += 2;
              if (input.includes('performance') || input.includes('theater')) score += 2;
              break;
          }
          
          scores[domain] = score;
        }
        
        console.log("Scores:", scores);
        
        // Find the domain with the highest score
        let bestDomain = 'general';
        let bestScore = 0;
        
        for (const [domain, score] of Object.entries(scores)) {
          if (score > bestScore) {
            bestScore = score;
            bestDomain = domain;
          }
        }
        
        // If no strong match, default to user's preferred domain or general
        if (bestScore === 0) {
          bestDomain = this.getPreferredDomain();
        }
        
        // Update stats
        if (bestDomain !== 'general') {
          this.stats.exploredDomains.add(bestDomain);
        }
        
        console.log("Best domain:", bestDomain, "with score:", bestScore);
        
        return {
          domain: bestDomain,
          confidence: bestScore > 0 ? Math.min(bestScore / 10, 1) : 0
        };
      }

      generateIdeas(inputAnalysis, userInput, count = 2) {
        const { domain } = inputAnalysis;
        console.log("Generating ideas for domain:", domain);
        const ideas = [];
        
        // Get templates for the identified domain
        const templates = this.ideaTemplates[domain] || [
          'An innovative approach to {domain}',
          'A platform for {domain} enthusiasts',
          'A solution that improves {domain}',
          'An educational resource for {domain}',
          'A community focused on {domain}',
          'A research initiative exploring {domain}',
          'A toolkit for {domain} practitioners',
          'A collaborative project for {domain}',
          'An experimental approach to {domain}',
          'A cross-domain solution involving {domain}'
        ];
        
        // Replace {domain} placeholder with user's specific interest
        // Extract key terms from user input to personalize
        const keyTerms = userInput.split(/[^\w\s]/).join(' ').split(/\s+/)
          .filter(word => word.length > 2)
          .filter(word => !['the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by'].includes(word.toLowerCase()))
          .slice(0, 3);
        const domainPlaceholder = keyTerms.length > 0 ? keyTerms[0] : 'your area of interest';
        
        console.log("Key terms:", keyTerms, "Domain placeholder:", domainPlaceholder);
        
        for (let i = 0; i < count && i < templates.length; i++) {
          // Select a template that hasn't been used recently
          const availableTemplates = templates.filter(template => 
            !this.conversationHistory.some(msg => 
              msg.text && msg.text.includes(template.replace(/\{domain\}/g, domainPlaceholder)))
          );
          
          const template = availableTemplates.length > 0 ? 
            availableTemplates[i % availableTemplates.length] : 
            templates[i % templates.length];
            
          const idea = template.replace(/\{domain\}/g, domainPlaceholder);
          
          // Create idea object with metadata
          const ideaObj = {
            id: Date.now() + i,
            text: idea,
            domain: domain,
            timestamp: Date.now(),
            originalTemplate: template
          };
          
          ideas.push(ideaObj);
          console.log(`Generated idea ${i+1}:`, idea);
        }
        
        // Update stats
        this.stats.totalIdeas += ideas.length;
        
        return ideas;
      }

      generateFollowupQuestion(contextType = 'exploration', domain = 'general') {
        const templates = this.followupTemplates[contextType] || this.followupTemplates.exploration;
        const randomTemplate = templates[Math.floor(Math.random() * templates.length)];
        
        // Replace {domain} placeholder if present
        return randomTemplate.replace(/\{domain\}/g, domain);
      }

      generateResponse(userInput) {
        console.log("Generating professional response for:", userInput);
        
        // Analyze the user input
        const analysis = this.analyzeInput(userInput);
        
        // Generate ideas
        const ideas = this.generateIdeas(analysis, userInput);
        
        // Determine response type based on context and conversation history
        let responseText;
        const conversationDepth = this.conversationHistory.filter(msg => msg.isUser).length;
        
        if (conversationDepth <= 1) {
          // First interaction - use welcoming response
          const domainResponses = {
            technology: "技术是一个充满机遇的领域！我识别出您对科技的兴趣。基于您的输入，这里有一些想法：",
            sustainability: "可持续发展是一个重要的领域！我看出您关注环境影响。这里有一些有影响力的想法供您参考：",
            education: "教育是进步的基础！我注意到您在思考学习相关的话题。这里有一些学习导向的想法：",
            health: "健康和福祉至关重要！我看到您对健康话题感兴趣。这里有一些相关的思路：",
            creativity: "创造力推动创新！我可以看出您有艺术方面的兴趣。这里有一些创意项目的想法：",
            business: "商业创新可以产生真正的影响力！我注意到创业思维。这里有一些商业导向的想法：",
            social_impact: "社会影响力工作非常有意义！我看到您关心如何产生影响。这里有一些您可以产生影响的方式：",
            art: "艺术丰富我们的生活！我可以看出您对创意表达有兴趣。这里有一些艺术相关的想法：",
            general: "听起来很有趣！我分析了您的输入，这里有一些基于您兴趣的想法："
          };
          
          responseText = domainResponses[analysis.domain] || domainResponses.general;
        } else if (conversationDepth <= 3) {
          // Early follow-up - use more contextual response
          const followupResponses = {
            technology: "关于技术的有趣跟进！让我扩展一些可能性：",
            sustainability: "感谢您进一步阐述可持续性！这里有更多有针对性的想法：",
            education: "很高兴听到更多关于教育的信息！我有一些额外的想法：",
            health: "我很欣赏您分享更多关于健康主题的信息！请考虑这些方法：",
            creativity: "热爱您持续的创意兴趣！这里有更多的创意方向：",
            business: "感谢您深入探讨商业概念！这里有扩展的想法：",
            social_impact: "很棒，您继续思考社会影响！更多想法：",
            art: "更多艺术灵感！这里有额外的创意可能性：",
            general: "感谢您分享更多详情！基于我们的对话，这里有一些经过深思熟虑的想法："
          };
          
          responseText = followupResponses[analysis.domain] || followupResponses.general;
        } else {
          // Deeper conversation - use insight-oriented response
          const insightResponses = {
            technology: "基于我们之前的讨论，我对技术领域有了更深的见解。这里有一些更有针对性的想法：",
            sustainability: "经过我们深入的对话，我在可持续性方面有了新的视角。这里有更精细的想法：",
            education: "通过我们的交流，我对教育有了更好的理解。这里有一些更具体的建议：",
            health: "我们对话的深度让我对健康领域有了更细致的认识。这里有一些深入的想法：",
            creativity: "我们的创意交流激发了这些更富想象力的想法：",
            business: "基于我们多次的商业讨论，我提炼出这些更精准的商业想法：",
            social_impact: "通过我们持续的社会影响对话，我提出了这些更有深度的想法：",
            art: "我们艺术话题的深入交流启发了这些更精致的创意：",
            general: "通过我们深入的对话，我为您提炼出这些更符合您兴趣的想法："
          };
          
          responseText = insightResponses[analysis.domain] || insightResponses.general;
        }
        
        // Generate a relevant follow-up question based on conversation depth
        let followupContext;
        if (conversationDepth <= 1) followupContext = 'inspiration';
        else if (conversationDepth <= 3) followupContext = 'refinement';
        else followupContext = 'deep_dive';
        
        const followupQuestion = this.generateFollowupQuestion(followupContext, analysis.domain);
        
        console.log("Response text:", responseText);
        
        return {
          responseText: responseText,
          ideas: ideas,
          followupQuestion: followupQuestion,
          analysis: analysis
        };
      }
      
      // Save an idea to user's collection
      saveIdea(idea) {
        // Check if idea is already saved
        const alreadySaved = this.savedIdeas.some(saved => saved.id === idea.id);
        if (!alreadySaved) {
          this.savedIdeas.push({...idea});
          this.stats.savedIdeas = this.savedIdeas.length;
          return true;
        }
        return false;
      }
      
      // Remove a saved idea
      removeSavedIdea(ideaId) {
        this.savedIdeas = this.savedIdeas.filter(idea => idea.id !== ideaId);
        this.stats.savedIdeas = this.savedIdeas.length;
      }
      
      // Get all saved ideas
      getSavedIdeas() {
        return this.savedIdeas;
      }
      
      // Get statistics
      getStats() {
        return {
          totalIdeas: this.stats.totalIdeas,
          savedIdeas: this.stats.savedIdeas,
          exploredDomains: this.stats.exploredDomains.size,
          conversationTurns: this.stats.conversationTurns
        };
      }
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      const messagesContainer = document.getElementById('messages-container');
      const userInput = document.getElementById('user-input');
      const sendButton = document.getElementById('send-button');
      const ideaCountEl = document.getElementById('idea-count');
      const savedCountEl = document.getElementById('saved-count');
      const domainCountEl = document.getElementById('domain-count');
      const showSavedBtn = document.getElementById('show-saved-btn');
      const savedPanel = document.getElementById('saved-ideas-panel');
      const savedList = document.getElementById('saved-ideas-list');
      const closePanelBtn = document.getElementById('close-panel-btn');
      
      const ideaEngine = new ProfessionalIdeaEngine();
      let isProcessing = false;

      // Update stats display
      function updateStatsDisplay() {
        const stats = ideaEngine.getStats();
        ideaCountEl.textContent = stats.totalIdeas;
        savedCountEl.textContent = stats.savedIdeas;
        domainCountEl.textContent = stats.exploredDomains;
      }

      // Function to add a message to the chat
      function addMessage(text, isUser, ideaData = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'system'}`;
        
        const avatar = document.createElement('div');
        avatar.className = `avatar ${isUser ? 'user' : 'system'}`;
        avatar.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        
        // Process message text - split by newlines and create paragraphs
        const textParts = text.split('\n');
        textParts.forEach(part => {
          if (part.trim() !== '') {
            const p = document.createElement('p');
            p.textContent = part;
            bubble.appendChild(p);
          }
        });
        
        // If this is a system message with ideas, add idea items
        if (!isUser && ideaData && ideaData.ideas && ideaData.ideas.length > 0) {
          ideaData.ideas.forEach(ideaObj => {
            const ideaItem = document.createElement('div');
            ideaItem.className = 'idea-item';
            ideaItem.innerHTML = `
              <div>${ideaObj.text}</div>
              <div class="idea-actions">
                <button class="idea-btn save-btn" data-idea-id="${ideaObj.id}">
                  <i class="fas fa-bookmark"></i> 收藏
                </button>
                <button class="idea-btn like-btn" data-idea-id="${ideaObj.id}">
                  <i class="fas fa-thumbs-up"></i> 喜欢
                </button>
                <button class="idea-btn explore-btn" data-idea-id="${ideaObj.id}">
                  <i class="fas fa-search"></i> 深入
                </button>
              </div>
            `;
            bubble.appendChild(ideaItem);
          });
        }
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        messagesContainer.appendChild(messageDiv);
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Add event listeners for idea buttons
        if (!isUser && ideaData && ideaData.ideas) {
          ideaData.ideas.forEach(ideaObj => {
            document.querySelector(`.save-btn[data-idea-id="${ideaObj.id}"]`)?.addEventListener('click', () => {
              if (ideaEngine.saveIdea(ideaObj)) {
                // Visual feedback
                const btn = document.querySelector(`.save-btn[data-idea-id="${ideaObj.id}"]`);
                btn.innerHTML = '<i class="fas fa-check"></i> 已收藏';
                btn.style.background = '#dcfce7';
                btn.style.color = '#16a34a';
                btn.style.borderColor = '#86efac';
                
                setTimeout(() => {
                  btn.innerHTML = '<i class="fas fa-bookmark"></i> 收藏';
                  btn.style.background = '';
                  btn.style.color = '';
                  btn.style.borderColor = '';
                }, 2000);
                
                updateStatsDisplay();
              } else {
                alert('这个想法已经被收藏过了');
              }
            });
            
            document.querySelector(`.explore-btn[data-idea-id="${ideaObj.id}"]`)?.addEventListener('click', () => {
              userInput.value = `告诉我更多关于这个想法的信息: ${ideaObj.text}`;
              userInput.focus();
            });
          });
        }
      }

      // Function to show typing indicator
      function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message system';
        typingDiv.id = 'typing-indicator';
        
        const avatar = document.createElement('div');
        avatar.className = 'avatar system';
        avatar.innerHTML = '<i class="fas fa-robot"></i>';
        
        const indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        indicator.innerHTML = '<i class="fas fa-sync fa-spin"></i> <span>正在思考...</span>';
        
        typingDiv.appendChild(avatar);
        typingDiv.appendChild(indicator);
        messagesContainer.appendChild(typingDiv);
        
        // Scroll to bottom
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Function to hide typing indicator
      function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typing-indicator');
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      // Function to show saved ideas panel
      function showSavedIdeasPanel() {
        savedPanel.style.display = 'block';
        updateSavedIdeasList();
      }

      // Function to hide saved ideas panel
      function hideSavedIdeasPanel() {
        savedPanel.style.display = 'none';
      }

      // Function to update saved ideas list
      function updateSavedIdeasList() {
        savedList.innerHTML = '';
        
        if (ideaEngine.savedIdeas.length === 0) {
          savedList.innerHTML = '<p style="color:var(--gray-500); text-align:center; padding:20px;">还没有收藏任何想法</p>';
          return;
        }
        
        ideaEngine.savedIdeas.forEach(idea => {
          const ideaEl = document.createElement('div');
          ideaEl.className = 'saved-idea';
          ideaEl.innerHTML = `
            <div>${idea.text}</div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
              <span class="idea-tag">${idea.domain}</span>
              <button class="idea-btn" onclick="removeSavedIdea(${idea.id})" style="padding:4px 8px;">
                <i class="fas fa-trash"></i> 移除
              </button>
            </div>
          `;
          savedList.appendChild(ideaEl);
        });
      }

      // Function to remove saved idea (global for inline handler)
      window.removeSavedIdea = function(ideaId) {
        ideaEngine.removeSavedIdea(ideaId);
        updateSavedIdeasList();
        updateStatsDisplay();
      };

      // Function to handle sending a message
      function sendMessage() {
        const message = userInput.value.trim();
        console.log("Sending message:", message);
        if (!message || isProcessing) return;
        
        // Add user message to history
        ideaEngine.addToHistory(message, true);
        
        // Add user message to UI
        addMessage(message, true);
        userInput.value = '';
        
        // Show typing indicator
        isProcessing = true;
        showTypingIndicator();
        sendButton.disabled = true;
        
        // Simulate AI processing
        setTimeout(() => {
          hideTypingIndicator();
          
          // Generate response using the idea engine
          const response = ideaEngine.generateResponse(message);
          
          // Format the response message
          let formattedResponse = response.responseText + "\n\n";
          
          // Add follow-up question
          if (response.followupQuestion) {
            formattedResponse += `\n❓ ${response.followupQuestion}`;
          }
          
          // Add system response to history
          ideaEngine.addToHistory(formattedResponse, false, {
            ideas: response.ideas,
            analysis: response.analysis
          });
          
          // Add system response to UI with idea data
          addMessage(formattedResponse, false, response);
          
          // Learn from the interaction
          ideaEngine.learnFromInteraction(message, response);
          
          // Update stats display
          updateStatsDisplay();
          
          isProcessing = false;
          sendButton.disabled = false;
        }, 1500);
      }

      // Event listeners
      sendButton.addEventListener('click', sendMessage);
      
      userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // Auto-resize textarea
      userInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
      });
      
      // Toggle saved ideas panel
      showSavedBtn.addEventListener('click', showSavedIdeasPanel);
      closePanelBtn.addEventListener('click', hideSavedIdeasPanel);
      
      // Close panel when clicking outside
      document.addEventListener('click', function(event) {
        if (savedPanel.style.display === 'block' && 
            !savedPanel.contains(event.target) && 
            event.target !== showSavedBtn) {
          hideSavedIdeasPanel();
        }
      });
      
      // Add initial welcome message if there are no messages
      if (messagesContainer.children.length === 0) {
        ideaEngine.addToHistory("你好！我是你的AI创意伙伴，今天想探索什么有趣的想法？", false);
        addMessage("你好！我是你的AI创意伙伴，今天想探索什么有趣的想法？", false);
        updateStatsDisplay();
      }
      
      // Initialize stats display
      updateStatsDisplay();
    });
  </script>
</body>
</html>